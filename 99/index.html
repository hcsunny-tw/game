<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ä¹ä¹˜æ³•ä½”åœ°éŠæˆ²</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šåŸºæœ¬å­—é«”å’Œå…¨è¢å¹•é«˜åº¦ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        .dice-grid {
            grid-template-columns: repeat(6, 1fr);
        }
        /* è‡ªå®šç¾©å½ˆå‡ºå‹•ç•« */
        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fade-in-up 0.3s ease-out forwards;
        }
        @keyframes dice-roll {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        .rolling {
            animation: dice-roll 0.1s infinite;
        }
    </style>
</head>
<body>

    <div id="game-container" class="min-h-screen p-2 md:p-6 flex flex-col items-center justify-center max-w-7xl mx-auto">
        <!-- éŠæˆ²å…§å®¹å°‡åœ¨æ­¤è™•æ¸²æŸ“ (Setup/Playing/Finished) -->
    </div>

    <!-- Modal å€åŸŸ -->
    <div id="modal-container"></div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let gameStage = 'setup'; // setup, playing, finished
        let playerCount = 2;
        let grid = [];
        let players = [];
        let currentTurn = 0;
        let diceValues = [1, 1, 1];
        let hasRolled = false;
        let possibleMoves = [];
        let isRolling = false;
        let winner = null;
        let showRules = false;

        const container = document.getElementById('game-container');
        const modalContainer = document.getElementById('modal-container');

        // ç©å®¶é¡è‰²è¨­å®š (èˆ‡ React ç‰ˆæœ¬ä¿æŒä¸€è‡´)
        const PLAYER_CONFIG = [
            { id: 0, name: 'ç©å®¶ 1', color: 'bg-red-500', lightColor: 'bg-red-100', border: 'border-red-500', text: 'text-red-600' },
            { id: 1, name: 'ç©å®¶ 2', color: 'bg-blue-500', lightColor: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-600' },
            { id: 2, name: 'ç©å®¶ 3', color: 'bg-green-500', lightColor: 'bg-green-100', border: 'border-green-500', text: 'text-green-600' },
            { id: 3, name: 'ç©å®¶ 4', color: 'bg-yellow-500', lightColor: 'bg-yellow-100', border: 'border-yellow-500', text: 'text-yellow-600' },
        ];

        // =========================================================================
        // ğŸ² éª°å­éŸ³æ•ˆå‡½å¼ (æ¨¡æ“¬å¤§å¯Œç¿éŠæˆ²çš„æ»¾å‹•è²)
        // ä½¿ç”¨ Web Audio API
        // =========================================================================
        function playDiceSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (!audioContext) return;

                const numClacks = 30; // å¢åŠ è²éŸ¿æ¬¡æ•¸ï¼Œæ¨¡æ“¬é€£çºŒæ»¾å‹•
                const baseTime = audioContext.currentTime;
                const clackInterval = 0.03; 

                for (let i = 0; i < numClacks; i++) {
                    const time = baseTime + (i * clackInterval); 

                    // 1. ç”¢ç”Ÿå™ªè² (Noise Generator)
                    const noise = audioContext.createBufferSource();
                    const bufferSize = audioContext.sampleRate * 0.1;
                    const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                    const output = buffer.getChannelData(0);
                    for (let j = 0; j < bufferSize; j++) {
                        output[j] = Math.random() * 2 - 1; 
                    }
                    noise.buffer = buffer;

                    // 2. éŸ³é‡æ§åˆ¶ (Gain Node)
                    const gainNode = audioContext.createGain();
                    gainNode.gain.setValueAtTime(0.001, time); 
                    gainNode.gain.linearRampToValueAtTime(0.1 + (Math.random() * 0.25), time + 0.005); 
                    const decayTime = 0.04; 
                    gainNode.gain.exponentialRampToValueAtTime(0.001, time + decayTime); 

                    // 3. å¸¶é€šæ¿¾æ³¢å™¨ (Filter) æ¨¡æ“¬ç©ºå¿ƒ clatter è²
                    const filter = audioContext.createBiquadFilter();
                    filter.type = 'bandpass'; 
                    filter.frequency.setValueAtTime(800 + (Math.random() * 400), time); 
                    filter.Q.setValueAtTime(3 + (Math.random() * 2), time); 

                    // é€£æ¥ç¯€é»
                    noise.connect(gainNode);
                    gainNode.connect(filter);
                    filter.connect(audioContext.destination);

                    // å•Ÿå‹•èˆ‡åœæ­¢è²éŸ¿
                    noise.start(time);
                    noise.stop(time + decayTime);
                }

            } catch (e) {
                console.log("Failed to play dice sound:", e.message); 
            }
        }

        // =========================================================================
        // æ ¸å¿ƒéŠæˆ²é‚è¼¯å‡½å¼
        // =========================================================================

        function startGame() {
            const uniqueProducts = new Set();
            for (let i = 1; i <= 9; i++) {
                for (let j = 1; j <= 9; j++) {
                    uniqueProducts.add(i * j);
                }
            }

            const productArray = Array.from(uniqueProducts);
            // éš¨æ©Ÿæ´—ç‰Œ
            for (let i = productArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [productArray[i], productArray[j]] = [productArray[j], productArray[i]];
            }

            const gridValues = productArray.slice(0, 36);

            grid = gridValues.map((val, index) => ({
                id: index,
                value: val,
                owner: null,
            }));

            // è™•ç†å–®äººæ¨¡å¼ (Human vs. AI)
            let actualPlayerCount = playerCount;
            if (playerCount === 1) {
                actualPlayerCount = 2; 
            }

            players = PLAYER_CONFIG.slice(0, actualPlayerCount).map((p, index) => {
                const isAI = playerCount === 1 && index === 1;
                let name = p.name;
                if (playerCount === 1 && index === 0) {
                    name = 'ç©å®¶'; 
                } else if (isAI) {
                    name = 'é›»è…¦ AI ğŸ¤–'; 
                }
                
                return {
                    ...p,
                    name,
                    score: 0,
                    territories: 0,
                    isAI: isAI
                };
            });

            currentTurn = 0;
            diceValues = [1, 1, 1];
            hasRolled = false;
            possibleMoves = [];
            gameStage = 'playing';
            winner = null;
            closeModal();
            render();
            // å¦‚æœæ˜¯ AI å›åˆï¼Œå•Ÿå‹• AI é‚è¼¯
            if (players[currentTurn].isAI) {
                handleAIMove(players[currentTurn]);
            }
        }

        function finishRoll(d1, d2, d3) {
            diceValues = [d1, d2, d3];
            isRolling = false;
            hasRolled = true;

            const products = [d1 * d2, d1 * d3, d2 * d3];
            const uniqueProducts = [...new Set(products)];
            possibleMoves = [];

            grid.forEach(cell => {
                if (cell.owner === null && uniqueProducts.includes(cell.value)) {
                    possibleMoves.push(cell.id);
                }
            });

            render();
        }

        function rollDice() {
            if (isRolling || hasRolled || gameStage !== 'playing' || players[currentTurn].isAI) return;

            isRolling = true;
            possibleMoves = [];
            closeFeedback();
            
            playDiceSound(); 
            
            let count = 0;
            const interval = setInterval(() => {
                diceValues = [
                    Math.floor(Math.random() * 9) + 1,
                    Math.floor(Math.random() * 9) + 1,
                    Math.floor(Math.random() * 9) + 1
                ];
                render(); // å¿«é€Ÿæ›´æ–°ç•«é¢æ¨¡æ“¬æ»¾å‹•
                count++;
                if (count > 10) {
                    clearInterval(interval);
                    const d1 = Math.floor(Math.random() * 9) + 1;
                    const d2 = Math.floor(Math.random() * 9) + 1;
                    const d3 = Math.floor(Math.random() * 9) + 1;
                    finishRoll(d1, d2, d3);
                }
            }, 100);
            render();
        }

        function getNeighbors(index) {
            const row = Math.floor(index / 6);
            const col = index % 6;
            const neighbors = [];

            if (row > 0) neighbors.push(index - 6); 
            if (row < 5) neighbors.push(index + 6); 
            if (col > 0) neighbors.push(index - 1); 
            if (col < 5) neighbors.push(index + 1); 

            return neighbors;
        }

        function updateScores(currentGrid) {
            players = players.map(player => {
                let baseScore = 0;
                let territoryCount = 0;

                currentGrid.forEach((cell, index) => {
                    if (cell.owner === player.id) {
                        territoryCount++;
                        const neighbors = getNeighbors(index);
                        const isConnected = neighbors.some(nIndex => currentGrid[nIndex] && currentGrid[nIndex].owner === player.id);
                        baseScore += isConnected ? 2 : 1;
                    }
                });

                // æ³¨æ„ï¼šåœ¨ç´” JS ä¸­ï¼Œæˆ‘å€‘ç›´æ¥ä¿®æ”¹ players é™£åˆ—
                return { ...player, score: baseScore, territories: territoryCount, isAI: player.isAI };
            });
        }

        function checkGameEnd() {
            const isFull = grid.every(cell => cell.owner !== null);
            if (isFull) {
                updateScores(grid); 
                gameStage = 'finished';
                const sortedPlayers = [...players].sort((a, b) => b.score - a.score);
                winner = sortedPlayers[0];
                render();
            } else {
                nextTurn();
            }
        }

        function nextTurn() {
            hasRolled = false;
            possibleMoves = [];
            currentTurn = (currentTurn + 1) % players.length;
            render();
            // æª¢æŸ¥ä¸‹ä¸€ä½æ˜¯å¦æ˜¯ AI
            if (players[currentTurn].isAI) {
                setTimeout(() => handleAIMove(players[currentTurn]), 500);
            }
        }

        function handleCellClick(cellId) {
            if (!hasRolled || gameStage !== 'playing') return;
            if (grid[cellId].owner !== null) return; 

            const [d1, d2, d3] = diceValues;
            const products = [d1 * d2, d1 * d3, d2 * d3];
            const uniqueProducts = [...new Set(products)];

            if (uniqueProducts.includes(grid[cellId].value)) {
                grid[cellId].owner = currentTurn;
                
                updateScores(grid);
                checkGameEnd();
            } else {
                showFeedback('ç®—éŒ¯å›‰ï¼é€™ä¸æ˜¯éª°å­ç›¸ä¹˜çš„çµæœï¼Œå†ç®—ç®—çœ‹ã€‚', 'error');
            }
            render();
        }

        function handleSkipRequest() {
            if (possibleMoves.length > 0) {
                showSkipConfirmModal();
            } else {
                confirmSkip();
            }
        }

        function confirmSkip() {
            closeModal();
            updateScores(grid); 
            nextTurn();
        }

        function handleResetRequest() {
            showResetConfirmModal();
        }
        
        function confirmReset() {
            closeModal();
            gameStage = 'setup';
            render();
        }

        // =========================================================================
        // AI é‚è¼¯
        // =========================================================================
        function handleAIMove(aiPlayer) {
            // 1. æ¨¡æ“¬æ“²éª°å‹•ç•«
            isRolling = true;
            playDiceSound(); 
            render();
            
            setTimeout(() => {
                const d1 = Math.floor(Math.random() * 9) + 1;
                const d2 = Math.floor(Math.random() * 9) + 1;
                const d3 = Math.floor(Math.random() * 9) + 1;
                const finalDice = [d1, d2, d3];

                diceValues = finalDice;
                isRolling = false;
                hasRolled = true;
                render();

                const products = [d1 * d2, d1 * d3, d2 * d3];
                const uniqueProducts = [...new Set(products)];
                
                // 2. AI æ±ºç­–
                const moves = [];
                grid.forEach(cell => {
                    if (cell.owner === null && uniqueProducts.includes(cell.value)) {
                        moves.push({ id: cell.id, value: cell.value });
                    }
                });

                let bestMoveId = null;
                let maxScore = 0;
                
                for (const move of moves) {
                    const neighbors = getNeighbors(move.id);
                    const isConnected = neighbors.some(nIndex => grid[nIndex].owner === aiPlayer.id);
                    const score = isConnected ? 2 : 1;
                    
                    if (score > maxScore) {
                        maxScore = score;
                        bestMoveId = move.id;
                    }
                }
                
                // 3. åŸ·è¡Œå‹•ä½œ (å»¶é² 1 ç§’æ¨¡æ“¬æ€è€ƒæ™‚é–“)
                setTimeout(() => {
                    if (bestMoveId !== null) {
                        grid[bestMoveId].owner = aiPlayer.id;
                        updateScores(grid);
                        checkGameEnd(); 
                    } else {
                        showFeedback('é›»è…¦ AI é¸æ“‡è·³éå›åˆã€‚', 'info');
                        nextTurn(); 
                    }
                    render();
                }, 1000); 
            }, 500); 
        }

        // =========================================================================
        // UI æ¸²æŸ“èˆ‡äº’å‹• (ç´” JavaScript)
        // =========================================================================
        
        let feedbackTimeout = null;
        function showFeedback(msg, type) {
            const fbElement = document.getElementById('feedback-message');
            if (fbElement) {
                fbElement.innerHTML = `
                    <div class="px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}">
                        ${type === 'error' ? 'âŒ' : 'â„¹ï¸'}
                        ${msg}
                    </div>
                `;
                fbElement.classList.remove('hidden');
                fbElement.classList.add('animate-bounce');

                if (feedbackTimeout) clearTimeout(feedbackTimeout);
                feedbackTimeout = setTimeout(() => {
                    closeFeedback();
                }, 2500);
            }
        }
        
        function closeFeedback() {
            const fbElement = document.getElementById('feedback-message');
            if (fbElement) {
                fbElement.classList.add('hidden');
                fbElement.classList.remove('animate-bounce');
            }
        }

        function closeModal() {
            modalContainer.innerHTML = '';
        }

        function showSkipConfirmModal() {
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center animate-fade-in-up border-4 border-yellow-400">
                        <div class="flex justify-center mb-4">
                            <span class="text-yellow-500 text-6xl">â“</span>
                        </div>
                        <h3 class="text-2xl font-black text-gray-800 mb-4">ç¢ºå®šè¦è·³éå—ï¼Ÿ</h3>
                        <p class="text-gray-600 mb-8 font-medium">
                            ç›¤é¢ä¸Šé‚„æœ‰å¯ä»¥ä½”é ˜çš„ç­”æ¡ˆå–”ï¼<br/>
                            å†ä»”ç´°ç®—ç®—çœ‹ï¼Ÿ
                        </p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold transition-colors">
                                æˆ‘å†æƒ³æƒ³
                            </button>
                            <button onclick="confirmSkip()" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold shadow-lg transition-transform active:scale-95">
                                å¿ç—›è·³é
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function showResetConfirmModal() {
            modalContainer.innerHTML = `
                <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white p-6 rounded-3xl shadow-2xl max-w-sm w-full text-center animate-fade-in-up border-4 border-red-400">
                        <div class="flex justify-center mb-4">
                            <span class="text-red-500 text-6xl">âš ï¸</span>
                        </div>
                        <h3 class="text-2xl font-black text-gray-800 mb-4">ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿ</h3>
                        <p class="text-gray-600 mb-8 font-medium">
                            éŠæˆ²å°‡æœƒå›åˆ°è¨­å®šç•«é¢ï¼Œç›®å‰çš„é€²åº¦å°‡æœƒéºå¤±ã€‚
                        </p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="closeModal()" class="flex-1 py-3 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-bold transition-colors">
                                å–æ¶ˆ
                            </button>
                            <button onclick="confirmReset()" class="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold shadow-lg transition-transform active:scale-95">
                                ç¢ºèªé‡ç½®
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderSetupStage() {
            container.className = "min-h-screen bg-green-50 flex flex-col items-center justify-center p-4 font-sans";
            container.innerHTML = `
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-md w-full text-center border-4 border-green-500">
                    <h1 class="text-4xl font-black text-green-600 mb-2 tracking-wider">âœ¨ ä¹ä¹ä¹˜æ³• âœ¨</h1>
                    <h2 class="text-2xl font-bold text-green-500 mb-6">ğŸ° ä½”åœ°éŠæˆ² 2.0 ğŸ°</h2>
                    
                    <div class="bg-green-50 p-5 rounded-2xl mb-6 text-left border-2 border-green-200 shadow-inner">
                        <h3 class="font-bold text-green-800 mb-3 text-center text-lg flex items-center justify-center gap-2">
                            â„¹ï¸ æ€éº¼ç©ï¼Ÿ
                        </h3>
                        <ul class="space-y-2 text-green-700 text-sm font-medium">
                            <li class="flex items-start gap-2">
                                <span class="text-lg">ğŸ²</span> 
                                <span><b>æ“²éª°å­</b>ï¼šæ¯å›åˆæ“²å‡º 3 é¡†æ•¸å­—éª°ã€‚</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-lg">ğŸ§®</span> 
                                <span><b>ç®—ä¹˜æ³•</b>ï¼šä»»é¸ 2 é¡†éª°å­ç›¸ä¹˜ã€‚</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-lg">ğŸš©</span> 
                                <span><b>ä½”é ˜åœ°</b>ï¼šé»æ“Šå°æ‡‰çš„æ•¸å­—æ ¼å­ä½”é ˜ã€‚</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-lg">ğŸ”—</span> 
                                <span><b>é€£é€£çœ‹</b>ï¼šèˆ‡è‡ªå·±åœŸåœ°ç›¸é€£ï¼Œåˆ†æ•¸åŠ å€ï¼</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-lg">ğŸ‘‘</span> 
                                <span><b>çˆ­å† è»</b>ï¼šåœŸåœ°è¢«ä½”æ»¿å¾Œï¼Œåˆ†æ•¸é«˜è€…ç²å‹ã€‚</span>
                            </li>
                        </ul>
                    </div>

                    <div class="mb-8">
                        <label class="block text-gray-700 text-lg font-bold mb-4">ğŸ‘¥ é¸æ“‡ç©å®¶äººæ•¸</label>
                        <div class="flex justify-center gap-4">
                            ${[1, 2, 3, 4].map(num => `
                                <button
                                    onclick="playerCount = ${num}; render();"
                                    class="w-16 h-16 rounded-2xl text-2xl font-black transition-all duration-200 border-b-4 ${
                                        playerCount === num 
                                        ? 'bg-green-500 text-white border-green-700 scale-110 shadow-lg translate-y-[-4px]' 
                                        : 'bg-gray-100 text-gray-400 border-gray-300 hover:bg-gray-200 hover:border-gray-400'
                                    }"
                                >
                                    ${num}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <button
                        onclick="startGame()"
                        class="w-full bg-gradient-to-b from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white text-xl font-black py-4 rounded-2xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 group"
                    >
                        ğŸ² é–‹å§‹éŠæˆ² GO!
                    </button>

                    <div class="mt-6 text-green-400 text-xs font-bold tracking-widest">
                        éŠæˆ²è¨­è¨ˆï¼šå°ç›Šçš„å¸ƒæ‹‰æ ¼å»£å ´FB ï¼› ç¶²é è¨­è¨ˆï¼šå½­å½­è€å¸«
                    </div>
                </div>
            `;
        }

        function renderPlayingStage() {
            const currentPlayer = players[currentTurn];
            const isCurrentPlayerAI = currentPlayer.isAI;
            
            container.className = "min-h-screen p-2 md:p-6 font-sans flex flex-col md:flex-row gap-4 max-w-7xl mx-auto";
            
            container.innerHTML = `
                <!-- å·¦å´ï¼šè¨ˆåˆ†æ¿ -->
                <div class="w-full md:w-1/4 flex flex-col gap-4 order-2 md:order-1">
                    <div class="bg-white rounded-xl shadow-md p-4 border-t-4 border-green-600">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                                ğŸ‘¥ è¨ˆåˆ†æ¿
                            </h3>
                            <button 
                                onclick="showRules = !showRules; render();"
                                class="text-gray-400 hover:text-green-600"
                            >
                                â„¹ï¸
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            ${players.map((player) => `
                                <div class="flex justify-between items-center p-3 rounded-lg border-l-4 ${player.border} ${currentTurn === player.id ? 'bg-gray-50 shadow-inner ring-2 ring-offset-1 ring-green-400' : 'bg-white'}">
                                    <div>
                                        <span class="font-bold block ${player.text}">${player.name}</span>
                                        <span class="text-xs text-gray-500">ä½”åœ°: ${player.territories}</span>
                                    </div>
                                    <div class="text-2xl font-black text-gray-700">${player.score}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${showRules ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-sm text-yellow-800">
                            <h4 class="font-bold mb-2">éŠæˆ²è¦å‰‡ï¼š</h4>
                            <ul class="list-disc list-inside space-y-1">
                                <li>æ“² 3 é¡† 1-9 æ•¸å­—éª°å­ã€‚</li>
                                <li>ä»»é¸å…¶ä¸­å…©é¡†ç›¸ä¹˜ã€‚</li>
                                <li>ä¹˜ç©å³ç‚ºå¯ä½”é ˜çš„åœŸåœ°ã€‚</li>
                                <li>ä¸€å¡Šåœ°å¾— 1 åˆ†ã€‚</li>
                                <li>èˆ‡è‡ªå·±é ˜åœŸ<strong>ç›¸é€£</strong>çš„åœ°ï¼Œåˆ†æ•¸åŠ å€ã€‚</li>
                                <li>è‹¥ç„¡åœ°å¯ä½”ï¼Œè«‹æŒ‰ã€Œè·³éå›åˆã€ã€‚</li>
                            </ul>
                        </div>
                    ` : ''}
                </div>

                <!-- ä¸­é–“ï¼šæ£‹ç›¤ -->
                <div class="flex-1 flex flex-col items-center justify-center order-1 md:order-2 relative">
                    
                    <!-- éŒ¯èª¤/æç¤ºè¨Šæ¯è¦†è“‹å±¤ -->
                    <div id="feedback-message" class="absolute top-4 z-10 hidden"></div>

                    <div class="bg-white p-2 md:p-6 rounded-xl shadow-xl border-4 border-gray-800">
                        <div class="dice-grid grid gap-1 md:gap-2 bg-gray-300 p-1 md:p-2 rounded">
                            ${grid.map((cell) => {
                                const owner = players.find(p => p.id === cell.owner);
                                const isOccupied = cell.owner !== null;
                                
                                return `
                                    <button
                                        onclick="handleCellClick(${cell.id})"
                                        ${isCurrentPlayerAI || !hasRolled || isOccupied ? 'disabled' : ''}
                                        class="
                                            w-12 h-12 md:w-20 md:h-20 flex items-center justify-center text-lg md:text-2xl font-black rounded transition-all duration-200
                                            ${cell.owner === null ? 'bg-gray-100 text-gray-800 hover:bg-gray-200' : `${owner.color} text-white shadow-inner`}
                                            ${(isCurrentPlayerAI || !hasRolled) && cell.owner === null ? 'opacity-50 cursor-not-allowed' : ''}
                                            ${!isCurrentPlayerAI && hasRolled && !isOccupied ? 'cursor-pointer hover:scale-105 hover:shadow-md active:scale-95' : ''}
                                        "
                                    >
                                        ${cell.value}
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <!-- å³å´/ä¸‹æ–¹ï¼šæ§åˆ¶å€ -->
                <div class="w-full md:w-1/4 flex flex-col gap-4 order-3">
                    <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 ${currentPlayer.border}">
                        <div class="text-center mb-4">
                            <span class="text-gray-500 text-sm uppercase tracking-wider">ç•¶å‰å›åˆ</span>
                            <h2 class="text-2xl font-bold ${currentPlayer.text}">
                                ${currentPlayer.name}
                            </h2>
                        </div>

                        <div class="flex justify-center gap-3 mb-6">
                            ${diceValues.map((val) => `
                                <div class="w-12 h-12 bg-white border-2 border-gray-800 rounded-lg flex items-center justify-center text-xl font-bold shadow-md ${isRolling ? 'rolling' : ''}">
                                    ${val}
                                </div>
                            `).join('')}
                        </div>

                        ${!hasRolled && !isCurrentPlayerAI ? `
                            <button
                                onclick="rollDice()"
                                ${isRolling ? 'disabled' : ''}
                                class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95 ${isRolling ? 'bg-gray-400' : 'bg-gray-800 hover:bg-gray-900'}"
                            >
                                ${isRolling ? 'ğŸ² æ“²éª°ä¸­...' : 'ğŸ² æ“²éª°å­'}
                            </button>
                        ` : isCurrentPlayerAI ? `
                            <div class="w-full py-4 bg-gray-200 text-gray-600 rounded-xl text-center font-bold text-lg animate-pulse">
                                é›»è…¦ AI æ€è€ƒä¸­...
                            </div>
                        ` : `
                            <div class="space-y-3">
                                <div class="text-center text-gray-600 font-bold mb-2">
                                    è«‹é»é¸è¨ˆç®—å‡ºçš„ä¹˜ç©æ ¼å­
                                </div>
                                
                                ${possibleMoves.length === 0 ? `
                                    <div class="bg-red-50 text-red-600 p-2 rounded text-center text-sm mb-2">
                                        ä¼¼ä¹æ²’æœ‰å¯ä»¥ä½”é ˜çš„æ ¼å­å›‰...
                                    </div>
                                ` : ''}

                                <button
                                    onclick="handleSkipRequest()"
                                    class="w-full py-3 bg-red-100 text-red-600 hover:bg-red-200 rounded-xl font-bold flex items-center justify-center gap-2"
                                >
                                    âŒ è·³éå›åˆ
                                </button>
                            </div>
                        `}
                    </div>

                    <button 
                        onclick="handleResetRequest()" 
                        class="bg-white text-gray-500 hover:text-red-500 p-4 rounded-xl shadow hover:shadow-md transition-all flex items-center justify-center gap-2"
                    >
                        ğŸ”„ é‡ç½®éŠæˆ²
                    </button>
                </div>
                
                <!-- éŠæˆ²çµæŸ Modal æ¸²æŸ“ -->
                ${gameStage === 'finished' && winner ? `
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center animate-fade-in-up">
                            <div class="flex justify-center mb-4">
                                <span class="text-yellow-500 text-6xl">ğŸ†</span>
                            </div>
                            <h2 class="text-3xl font-black text-gray-800 mb-2">éŠæˆ²çµæŸ!</h2>
                            <p class="text-gray-500 mb-6">æ‰€æœ‰çš„åœŸåœ°éƒ½è¢«ä½”é ˜äº†</p>
                            
                            <div class="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-200 mb-6">
                                <span class="text-sm text-yellow-600 font-bold uppercase">ç²å‹è€…</span>
                                <div class="text-3xl font-black ${winner.text} mt-1">
                                    ${winner.name}
                                </div>
                                <div class="text-2xl font-bold text-gray-700 mt-2">
                                    ${winner.score} åˆ†
                                </div>
                            </div>

                            <button
                                onclick="startGame()"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg"
                            >
                                å†ç©ä¸€æ¬¡
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;
        }


        function render() {
            closeModal();
            if (gameStage === 'setup') {
                renderSetupStage();
            } else if (gameStage === 'playing' || gameStage === 'finished') {
                renderPlayingStage();
            }
        }

        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•
        window.onload = render;

    </script>
</body>
</html>
