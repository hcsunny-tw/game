<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—å°‹å¯¶ (Word Search) éŠæˆ²</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* è‡ªè¨‚æ¨£å¼ */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: none; /* ç¦ç”¨è§¸æ§æ»‘å‹•é é¢ï¼Œå„ªåŒ–éŠæˆ²é«”é©— */
        }
        .grid-cell {
            width: 45px; /* å¢åŠ å¤§å°ä»¥åˆ©è§¸æ§ */
            height: 45px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        .grid-cell.selecting {
            background-color: #60a5fa; /* è—è‰² */
            color: white;
        }
        .grid-cell.found {
            background-color: #4ade80; /* ç¶ è‰² */
            color: white;
        }
        .grid-cell.hint {
            animation: hint-pulse 1.5s infinite;
        }
        @keyframes hint-pulse {
            0% { background-color: #facc15; } /* é»ƒè‰² */
            50% { background-color: #fde047; }
            100% { background-color: #facc15; }
        }
        /* éŸ¿æ‡‰å¼èª¿æ•´æ ¼å­å¤§å° */
        @media (max-width: 768px) {
            .grid-cell {
                width: 35px; /* ç‚ºå¹³æ¿èª¿æ•´ */
                height: 35px;
                font-size: 16px;
            }
        }
        @media (max-width: 480px) {
            .grid-cell {
                width: 28px; /* ç‚ºæ‰‹æ©Ÿèª¿æ•´ */
                height: 28px;
                font-size: 14px; /* ç¨å¾®åŠ å¤§å­—é«” */
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 flex flex-col min-h-screen">

    <main class="w-full flex-grow flex items-center justify-center p-4">
        <div id="app-container" class="w-full max-w-7xl mx-auto">

            <!-- é–‹å§‹ç•«é¢ -->
            <div id="start-screen" class="text-center bg-white p-8 rounded-2xl shadow-lg">
                <h1 class="text-4xl md:text-5xl font-bold text-blue-600 mb-4">å–®å­—å°‹å¯¶éŠæˆ²</h1>
                <p class="text-slate-600 mb-8">è«‹é¸æ“‡éŠæˆ²è¨­å®šæˆ–å»ºç«‹è‡ªè¨‚éŠæˆ²</p>

                <div class="flex justify-center mb-8 border-b">
                    <button id="tab-standard" class="px-6 py-2 text-lg font-semibold text-blue-600 border-b-2 border-blue-600">æ¨™æº–æ¨¡å¼</button>
                    <button id="tab-custom" class="px-6 py-2 text-lg font-semibold text-slate-500">è€å¸«è‡ªè¨‚</button>
                </div>

                <!-- æ¨™æº–è¨­å®š -->
                <div id="standard-settings">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                        <!-- ä¸»é¡Œé¸æ“‡ -->
                        <div>
                            <label for="theme-select" class="block text-lg font-medium text-slate-700 mb-2">1. é¸æ“‡ä¸»é¡Œ</label>
                            <select id="theme-select" class="w-full p-3 border border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="animals">å‹•ç‰©</option>
                                <option value="fruits">æ°´æœ</option>
                                <option value="sports">é‹å‹•</option>
                            </select>
                        </div>
                        <!-- é›£æ˜“åº¦é¸æ“‡ -->
                        <div>
                            <label for="difficulty-select" class="block text-lg font-medium text-slate-700 mb-2">2. é¸æ“‡é›£æ˜“åº¦</label>
                            <select id="difficulty-select" class="w-full p-3 border border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="easy">ç°¡å–®</option>
                                <option value="normal">æ™®é€š</option>
                                <option value="hard">å›°é›£</option>
                            </select>
                        </div>
                        <!-- æ¨¡å¼é¸æ“‡ -->
                        <div>
                            <label for="mode-select" class="block text-lg font-medium text-slate-700 mb-2">3. é¸æ“‡æ¨¡å¼</label>
                            <select id="mode-select" class="w-full p-3 border border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="challenge">æŒ‘æˆ°æ¨¡å¼ (è¨ˆæ™‚)</option>
                                <option value="practice">ç·´ç¿’æ¨¡å¼ (ä¸è¨ˆæ™‚)</option>
                            </select>
                        </div>
                    </div>
                    <button id="start-game-btn" class="mt-10 bg-blue-600 text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-blue-700 transition-transform transform hover:scale-105">é–‹å§‹éŠæˆ²</button>
                </div>

                <!-- è€å¸«è‡ªè¨‚ -->
                <div id="custom-settings" class="hidden">
                     <p class="text-slate-600 mb-4">è«‹è¼¸å…¥ä¸»é¡Œå’Œå–®å­—åˆ—è¡¨ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼‰ï¼Œç„¶å¾Œç”¢ç”Ÿåˆ†äº«é€£çµçµ¦å­¸ç”Ÿã€‚</p>
                    <div class="max-w-2xl mx-auto text-left">
                        <div class="mb-4">
                            <label for="custom-theme" class="block text-lg font-medium text-slate-700 mb-2">ä¸»é¡Œåç¨±</label>
                            <input type="text" id="custom-theme" placeholder="ä¾‹å¦‚ï¼šç¬¬å…­èª²å–®å­—" class="w-full p-3 border border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="mb-6">
                            <label for="custom-words" class="block text-lg font-medium text-slate-700 mb-2">å–®å­—åˆ—è¡¨ (è«‹ç”¨è‹±æ–‡é€—è™Ÿ , åˆ†éš”)</label>
                            <textarea id="custom-words" rows="5" placeholder="ä¾‹å¦‚ï¼šapple,banana,orange,grape,..." class="w-full p-3 border border-slate-300 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                    </div>
                     <button id="generate-link-btn" class="bg-green-600 text-white font-bold py-4 px-12 rounded-full text-xl hover:bg-green-700 transition-transform transform hover:scale-105">ç”¢ç”ŸéŠæˆ²é€£çµ</button>
                     <div id="link-container" class="mt-6 hidden">
                         <p class="font-semibold text-slate-700">é€£çµå·²ç”¢ç”Ÿï¼è«‹è¤‡è£½ä¸¦åˆ†äº«çµ¦å­¸ç”Ÿï¼š</p>
                         <input type="text" id="generated-link" readonly class="w-full max-w-xl mx-auto mt-2 p-2 bg-slate-100 border border-slate-300 rounded-lg text-center">
                         <button id="copy-link-btn" class="mt-2 bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">è¤‡è£½é€£çµ</button>
                     </div>
                </div>
            </div>

            <!-- éŠæˆ²ç•«é¢ -->
            <div id="game-screen" class="hidden w-full">
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- å·¦å´ï¼šéŠæˆ²è³‡è¨Š -->
                    <div class="w-full lg:w-1/4 bg-white p-6 rounded-2xl shadow-lg order-2 lg:order-1">
                        <h2 id="game-theme" class="text-2xl font-bold text-blue-600 mb-4 text-center"></h2>
                        <div class="flex justify-between items-center mb-4 text-lg">
                            <span class="font-semibold">åˆ†æ•¸:</span>
                            <span id="score" class="font-bold text-2xl text-green-600">0</span>
                        </div>
                        <div id="timer-display" class="flex justify-between items-center mb-4 text-lg">
                            <span class="font-semibold">æ™‚é–“:</span>
                            <span id="timer" class="font-bold text-2xl text-slate-700">00:00</span>
                        </div>
                        <hr class="my-4">
                        <h3 class="text-xl font-bold mb-3 text-center">å¾…å°‹æ‰¾å–®å­—</h3>
                        <ul id="word-list" class="space-y-2 text-lg">
                            <!-- å–®å­—æœƒç”± JS å‹•æ…‹å¡«å…¥ -->
                        </ul>
                        <div class="mt-6 text-center">
                            <button id="hint-btn" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-full hover:bg-yellow-600 transition">æç¤º <span id="hints-left" class="bg-yellow-700 rounded-full px-2 ml-1">3</span></button>
                        </div>
                    </div>

                    <!-- å³å´ï¼šéŠæˆ²æ ¼å­ -->
                    <div class="w-full lg:w-3/4 bg-white p-4 md:p-6 rounded-2xl shadow-lg order-1 lg:order-2 flex justify-center items-center">
                        <div id="grid-container" class="grid" style="grid-template-columns: repeat(10, 1fr);">
                            <!-- æ ¼å­æœƒç”± JS å‹•æ…‹å¡«å…¥ -->
                        </div>
                    </div>
                </div>
                 <div class="text-center mt-6">
                    <button id="back-to-menu-btn" class="bg-slate-500 text-white font-bold py-3 px-8 rounded-full hover:bg-slate-600 transition">è¿”å›ä¸»é¸å–®</button>
                </div>
            </div>

        </div>

        <!-- å½ˆå‡ºè¦–çª— (Modal) -->
        <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div id="modal-content" class="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md w-full transform transition-all scale-95 opacity-0">
                <!-- å…§å®¹æœƒç”± JS å‹•æ…‹å¡«å…¥ -->
            </div>
        </div>
    </main>
    
    <footer class="w-full text-center py-4 bg-slate-100 border-t">
        <p class="text-sm text-slate-500">Â© 2025 Jennifer Peng (ç”± Gemini æ™ºæ…§åŠ©ç†å”åŠ©è£½ä½œ)</p>
    </footer>


    <script>
    // --- DOM å…ƒç´  ---
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const startGameBtn = document.getElementById('start-game-btn');
    const backToMenuBtn = document.getElementById('back-to-menu-btn');

    // è¨­å®š
    const themeSelect = document.getElementById('theme-select');
    const difficultySelect = document.getElementById('difficulty-select');
    const modeSelect = document.getElementById('mode-select');
    
    // éŠæˆ²ç•«é¢å…ƒç´ 
    const gameTheme = document.getElementById('game-theme');
    const scoreEl = document.getElementById('score');
    const timerDisplay = document.getElementById('timer-display');
    const timerEl = document.getElementById('timer');
    const wordListEl = document.getElementById('word-list');
    const gridContainer = document.getElementById('grid-container');
    const hintBtn = document.getElementById('hint-btn');
    const hintsLeftEl = document.getElementById('hints-left');

    // å½ˆå‡ºè¦–çª—
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modal-content');
    
    // è‡ªè¨‚åˆ†é 
    const tabStandard = document.getElementById('tab-standard');
    const tabCustom = document.getElementById('tab-custom');
    const standardSettings = document.getElementById('standard-settings');
    const customSettings = document.getElementById('custom-settings');
    const customThemeInput = document.getElementById('custom-theme');
    const customWordsInput = document.getElementById('custom-words');
    const generateLinkBtn = document.getElementById('generate-link-btn');
    const linkContainer = document.getElementById('link-container');
    const generatedLinkInput = document.getElementById('generated-link');
    const copyLinkBtn = document.getElementById('copy-link-btn');


    // --- éŠæˆ²è³‡æ–™ ---
    const wordData = {
        animals: {
            name: "å‹•ç‰©",
            words: [
                { word: 'LION', def: 'ç…å­', emoji: 'ğŸ¦' },
                { word: 'TIGER', def: 'è€è™', emoji: 'ğŸ¯' },
                { word: 'ELEPHANT', def: 'å¤§è±¡', emoji: 'ğŸ˜' },
                { word: 'MONKEY', def: 'çŒ´å­', emoji: 'ğŸ’' },
                { word: 'GIRAFFE', def: 'é•·é ¸é¹¿', emoji: 'ğŸ¦’' },
                { word: 'ZEBRA', def: 'æ–‘é¦¬', emoji: 'ğŸ¦“' },
                { word: 'SNAKE', def: 'è›‡', emoji: 'ğŸ' },
                { word: 'BEAR', def: 'ç†Š', emoji: 'ğŸ»' },
                { word: 'WOLF', def: 'ç‹¼', emoji: 'ğŸº' },
                { word: 'RABBIT', def: 'å…”å­', emoji: 'ğŸ°' },
                { word: 'FOX', def: 'ç‹ç‹¸', emoji: 'ğŸ¦Š' },
                { word: 'DEER', def: 'é¹¿', emoji: 'ğŸ¦Œ' },
                { word: 'EAGLE', def: 'è€é·¹', emoji: 'ğŸ¦…' },
                { word: 'OWL', def: 'è²“é ­é·¹', emoji: 'ğŸ¦‰' },
                { word: 'PANDA', def: 'ç†Šè²“', emoji: 'ğŸ¼' },
            ]
        },
        fruits: {
            name: "æ°´æœ",
            words: [
                { word: 'APPLE', def: 'è˜‹æœ', emoji: 'ğŸ' },
                { word: 'BANANA', def: 'é¦™è•‰', emoji: 'ğŸŒ' },
                { word: 'ORANGE', def: 'æ©˜å­', emoji: 'ğŸŠ' },
                { word: 'GRAPE', def: 'è‘¡è„', emoji: 'ğŸ‡' },
                { word: 'STRAWBERRY', def: 'è‰è“', emoji: 'ğŸ“' },
                { word: 'PINEAPPLE', def: 'é³³æ¢¨', emoji: 'ğŸ' },
                { word: 'WATERMELON', def: 'è¥¿ç“œ', emoji: 'ğŸ‰' },
                { word: 'MANGO', def: 'èŠ’æœ', emoji: 'ğŸ¥­' },
                { word: 'PEACH', def: 'æ¡ƒå­', emoji: 'ğŸ‘' },
                { word: 'CHERRY', def: 'æ«»æ¡ƒ', emoji: 'ğŸ’' },
                { word: 'LEMON', def: 'æª¸æª¬', emoji: 'ğŸ‹' },
                { word: 'KIWI', def: 'å¥‡ç•°æœ', emoji: 'ğŸ¥' },
                { word: 'BLUEBERRY', def: 'è—è“', emoji: 'ğŸ«' },
                { word: 'AVOCADO', def: 'é…ªæ¢¨', emoji: 'ğŸ¥‘' },
                { word: 'COCONUT', def: 'æ¤°å­', emoji: 'ğŸ¥¥' },
            ]
        },
        sports: {
            name: "é‹å‹•",
            words: [
                { word: 'SOCCER', def: 'è¶³çƒ', emoji: 'âš½' },
                { word: 'BASKETBALL', def: 'ç±ƒçƒ', emoji: 'ğŸ€' },
                { word: 'BASEBALL', def: 'æ£’çƒ', emoji: 'âš¾' },
                { word: 'TENNIS', def: 'ç¶²çƒ', emoji: 'ğŸ¾' },
                { word: 'VOLLEYBALL', def: 'æ’çƒ', emoji: 'ğŸ' },
                { word: 'SWIMMING', def: 'æ¸¸æ³³', emoji: 'ğŸŠ' },
                { word: 'RUNNING', def: 'è·‘æ­¥', emoji: 'ğŸƒ' },
                { word: 'GOLF', def: 'é«˜çˆ¾å¤«', emoji: 'â›³' },
                { word: 'BADMINTON', def: 'ç¾½æ¯›çƒ', emoji: 'ğŸ¸' },
                { word: 'TABLETENNIS', def: 'æ¡Œçƒ', emoji: 'ğŸ“' },
                { word: 'BOXING', def: 'æ‹³æ“Š', emoji: 'ğŸ¥Š' },
                { word: 'CYCLING', def: 'è‡ªè¡Œè»Š', emoji: 'ğŸš´' },
                { word: 'SKIING', def: 'æ»‘é›ª', emoji: 'â›·ï¸' },
                { word: 'FISHING', def: 'é‡£é­š', emoji: 'ğŸ£' },
                { word: 'YOGA', def: 'ç‘œçˆ', emoji: 'ğŸ§˜' },
            ]
        }
    };

    const difficultySettings = {
        easy: { gridSize: 10, wordCount: 8 },
        normal: { gridSize: 15, wordCount: 12 },
        hard: { gridSize: 20, wordCount: 16 },
    };

    // --- éŠæˆ²ç‹€æ…‹ ---
    let gameState = {
        grid: [],
        words: [],
        foundWords: [],
        score: 0,
        isTimerOn: false,
        timerInterval: null,
        seconds: 0,
        isMouseDown: false,
        selection: [],
        hintsLeft: 3
    };

    // --- éŠæˆ²é‚è¼¯ ---

    /** æ ¹æ“šè¨­å®šåˆå§‹åŒ–ä¸¦é–‹å§‹éŠæˆ² */
    function initGame(settings) {
        startScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');

        // 1. é‡è¨­éŠæˆ²ç‹€æ…‹
        resetGameState();
        gameState.isTimerOn = settings.isTimerOn;

        // 2. æº–å‚™å–®å­—
        const selectedWords = getRandomWords(wordData[settings.theme].words, settings.wordCount);
        gameState.words = selectedWords.map(w => ({...w, placed: false}));
        
        // 3. å»ºç«‹ä¸¦å¡«å……éŠæˆ²æ ¼å­
        createGrid(settings.gridSize);
        placeWords(gameState.words, gameState.grid);
        fillEmptyCells(gameState.grid);

        // 4. æ¸²æŸ“éŠæˆ²ç•«é¢
        renderGame(settings.theme);
        
        // 5. å•Ÿå‹•è¨ˆæ™‚å™¨
        if (gameState.isTimerOn) {
            timerDisplay.classList.remove('hidden');
            startTimer();
        } else {
            timerDisplay.classList.add('hidden');
        }
    }
    
    /** é‡è¨­éŠæˆ²ç‹€æ…‹ */
    function resetGameState() {
        gameState.grid = [];
        gameState.words = [];
        gameState.foundWords = [];
        gameState.score = 0;
        gameState.seconds = 0;
        gameState.isMouseDown = false;
        gameState.selection = [];
        gameState.hintsLeft = 3;
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
    }

    /** å¾å–®å­—åº«ä¸­éš¨æ©Ÿé¸å–æŒ‡å®šæ•¸é‡çš„å–®å­— */
    function getRandomWords(wordPool, count) {
        return [...wordPool].sort(() => 0.5 - Math.random()).slice(0, count);
    }
    
    /** å»ºç«‹æŒ‡å®šå¤§å°çš„ç©ºæ ¼å­ */
    function createGrid(size) {
        gameState.grid = Array.from({ length: size }, () => Array(size).fill(null));
    }

    /** å°‡å–®å­—æ”¾å…¥æ ¼å­ä¸­ */
    function placeWords(words, grid) {
        const size = grid.length;
        words.forEach(wordObj => {
            let placed = false;
            let attempts = 0;
            while (!placed && attempts < 100) {
                const direction = Math.random() > 0.5 ? 'horizontal' : 'vertical';
                const word = wordObj.word;
                let row, col;

                if (direction === 'horizontal') {
                    row = Math.floor(Math.random() * size);
                    col = Math.floor(Math.random() * (size - word.length + 1));
                } else { // vertical
                    row = Math.floor(Math.random() * (size - word.length + 1));
                    col = Math.floor(Math.random() * size);
                }

                if (canPlaceWord(word, row, col, direction, grid)) {
                    for (let i = 0; i < word.length; i++) {
                        if (direction === 'horizontal') {
                            grid[row][col + i] = word[i];
                        } else {
                            grid[row + i][col] = word[i];
                        }
                    }
                    wordObj.placed = { row, col, direction };
                    placed = true;
                }
                attempts++;
            }
        });
        // éæ¿¾æ‰æ²’æˆåŠŸæ”¾ç½®çš„å–®å­—
        gameState.words = gameState.words.filter(w => w.placed);
    }

    /** æª¢æŸ¥å–®å­—æ˜¯å¦å¯ä»¥è¢«æ”¾ç½®åœ¨æŒ‡å®šä½ç½® */
    function canPlaceWord(word, row, col, direction, grid) {
        for (let i = 0; i < word.length; i++) {
            let r = row, c = col;
            if (direction === 'horizontal') {
                c += i;
            } else {
                r += i;
            }
            if (grid[r][c] !== null && grid[r][c] !== word[i]) {
                return false;
            }
        }
        return true;
    }

    /** ç”¨éš¨æ©Ÿå­—æ¯å¡«å……ç©ºæ ¼ */
    function fillEmptyCells(grid) {
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        for (let r = 0; r < grid.length; r++) {
            for (let c = 0; c < grid.length; c++) {
                if (grid[r][c] === null) {
                    grid[r][c] = alphabet[Math.floor(Math.random() * alphabet.length)];
                }
            }
        }
    }
    
    /** æ¸²æŸ“æ•´å€‹éŠæˆ²ç•«é¢ */
    function renderGame(themeKey) {
        // ä¸»é¡Œ
        gameTheme.textContent = wordData[themeKey]?.name || 'è‡ªè¨‚ä¸»é¡Œ';
        
        // åˆ†æ•¸
        scoreEl.textContent = gameState.score;
        hintsLeftEl.textContent = gameState.hintsLeft;
        
        // å–®å­—åˆ—è¡¨
        wordListEl.innerHTML = '';
        gameState.words.forEach(wordObj => {
            const li = document.createElement('li');
            li.textContent = wordObj.word;
            li.id = `word-${wordObj.word}`;
            li.className = 'transition-all duration-300';
            wordListEl.appendChild(li);
        });

        // éŠæˆ²æ ¼å­
        const size = gameState.grid.length;
        gridContainer.innerHTML = '';
        gridContainer.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        for (let r = 0; r < size; r++) {
            for (let c = 0; c < size; c++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.textContent = gameState.grid[r][c];
                cell.dataset.row = r;
                cell.dataset.col = c;
                gridContainer.appendChild(cell);
            }
        }
    }

    /** é–‹å§‹è¨ˆæ™‚å™¨ */
    function startTimer() {
        gameState.timerInterval = setInterval(() => {
            gameState.seconds++;
            const minutes = Math.floor(gameState.seconds / 60).toString().padStart(2, '0');
            const seconds = (gameState.seconds % 60).toString().padStart(2, '0');
            timerEl.textContent = `${minutes}:${seconds}`;
        }, 1000);
    }

    /** æª¢æŸ¥é¸ä¸­çš„å–®å­— */
    function checkSelection() {
        // å¦‚æœé¸å–é•·åº¦å°æ–¼2 (ä¾‹å¦‚åªæ˜¯å–®é»)ï¼Œå°±æ¸…é™¤æ¨£å¼ä¸¦è¿”å›
        if (gameState.selection.length < 2) {
            gameState.selection.forEach(cell => cell.classList.remove('selecting'));
            gameState.selection = [];
            return;
        }
        
        const selectedString = gameState.selection.map(cell => cell.textContent).join('');
        const reversedString = selectedString.split('').reverse().join('');

        const unfoundWords = gameState.words.filter(w => !gameState.foundWords.includes(w.word));
        
        const foundWordObj = unfoundWords.find(w => w.word === selectedString || w.word === reversedString);
        
        if (foundWordObj) {
            // æ‰¾åˆ°å–®å­—
            gameState.foundWords.push(foundWordObj.word);
            gameState.score += 100;
            scoreEl.textContent = gameState.score;

            // æ›´æ–°æ¨£å¼
            gameState.selection.forEach(cell => cell.classList.add('found'));
            document.getElementById(`word-${foundWordObj.word}`).style.textDecoration = 'line-through';
            document.getElementById(`word-${foundWordObj.word}`).style.color = '#94a3b8';
            
            // é¡¯ç¤ºå›é¥‹è¦–çª—
            showWordFeedbackModal(foundWordObj);

            // æª¢æŸ¥éŠæˆ²æ˜¯å¦çµæŸ
            if (gameState.foundWords.length === gameState.words.length) {
                setTimeout(showGameOverModal, 1500);
            }

        } else {
            // æœªæ‰¾åˆ°
            gameState.selection.forEach(cell => cell.classList.remove('selecting'));
        }
        gameState.selection = [];
    }

    // --- å½ˆå‡ºè¦–çª—ç›¸é—œ ---
    
    function showWordFeedbackModal(wordObj) {
        modalContent.innerHTML = `
            <h2 class="text-3xl font-bold text-green-600 mb-4">æ‰¾åˆ°äº†ï¼</h2>
            <div class="text-8xl mb-4">${wordObj.emoji || 'âœ”ï¸'}</div>
            <p class="text-5xl font-bold mb-2">${wordObj.word}</p>
            <p class="text-2xl text-slate-600 mb-6">${wordObj.def}</p>
            <button id="modal-close-btn" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-full hover:bg-blue-700 transition">ç¹¼çºŒ</button>
        `;
        showModal();
        document.getElementById('modal-close-btn').onclick = hideModal;
    }
    
    function showGameOverModal() {
        if (gameState.timerInterval) clearInterval(gameState.timerInterval);
        
        let timeInfo = gameState.isTimerOn ? `<p class="text-lg">èŠ±è²»æ™‚é–“ï¼š<span class="font-bold">${timerEl.textContent}</span></p>` : '';

        modalContent.innerHTML = `
            <h2 class="text-3xl font-bold text-blue-600 mb-4">æ­å–œå®Œæˆï¼</h2>
            <p class="text-lg">æœ€çµ‚åˆ†æ•¸ï¼š<span class="font-bold text-2xl text-green-600">${gameState.score}</span></p>
            ${timeInfo}
            <h3 class="font-bold text-xl mt-6 mb-2">å–®å­—å›é¡§</h3>
            <ul class="text-left max-h-40 overflow-y-auto bg-slate-50 p-2 rounded-lg">
                ${gameState.words.map(w => `<li class="p-1">${w.emoji} ${w.word} - ${w.def}</li>`).join('')}
            </ul>
            <button id="modal-play-again-btn" class="mt-6 bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition">è¿”å›ä¸»é¸å–®</button>
        `;
        showModal();
        document.getElementById('modal-play-again-btn').onclick = () => {
            hideModal();
            gameScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        };
    }
    
    function showConfirmModal(message, onConfirm) {
        modalContent.innerHTML = `
            <h2 class="text-2xl font-bold text-slate-800 mb-4">è«‹ç¢ºèª</h2>
            <p class="text-lg text-slate-600 mb-8">${message}</p>
            <div class="flex justify-center gap-4">
                <button id="modal-cancel-btn" class="bg-slate-300 text-slate-800 font-bold py-3 px-8 rounded-full hover:bg-slate-400 transition">å–æ¶ˆ</button>
                <button id="modal-confirm-btn" class="bg-red-500 text-white font-bold py-3 px-8 rounded-full hover:bg-red-600 transition">ç¢ºå®š</button>
            </div>
        `;
        showModal();
        document.getElementById('modal-confirm-btn').onclick = () => {
            hideModal();
            if (onConfirm) onConfirm();
        };
        document.getElementById('modal-cancel-btn').onclick = hideModal;
    }

    function showModal() {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
    }
    
    function hideModal() {
        modalContent.classList.add('scale-95', 'opacity-0');
        modalContent.classList.remove('scale-100', 'opacity-100');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }

    // --- äº‹ä»¶ç›£è½ ---
    
    startGameBtn.addEventListener('click', () => {
        const settings = {
            theme: themeSelect.value,
            ...difficultySettings[difficultySelect.value],
            isTimerOn: modeSelect.value === 'challenge',
        };
        initGame(settings);
    });

    backToMenuBtn.addEventListener('click', () => {
        showConfirmModal('æ‚¨ç¢ºå®šè¦é›¢é–‹ç›®å‰çš„éŠæˆ²å—ï¼Ÿé€²åº¦å°‡ä¸æœƒå„²å­˜ã€‚', () => {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            gameScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        });
    });

    // æ ¼å­é»æ“Šæ‹–æ›³é‚è¼¯
    gridContainer.addEventListener('mousedown', e => {
        if (e.target.classList.contains('grid-cell')) {
            gameState.isMouseDown = true;
            gameState.selection = [e.target];
            e.target.classList.add('selecting');
        }
    });
    
    gridContainer.addEventListener('mousemove', e => {
        if (gameState.isMouseDown && e.target.classList.contains('grid-cell')) {
            if (!gameState.selection.includes(e.target)) {
                 const lastCell = gameState.selection[gameState.selection.length - 1];
                const currentRow = parseInt(e.target.dataset.row);
                const currentCol = parseInt(e.target.dataset.col);
                const lastRow = parseInt(lastCell.dataset.row);
                const lastCol = parseInt(lastCell.dataset.col);

                if (currentRow === lastRow || currentCol === lastCol) { // åƒ…é™ç›´ç·š
                    gameState.selection.push(e.target);
                    e.target.classList.add('selecting');
                }
            }
        }
    });

    window.addEventListener('mouseup', () => {
        if (gameState.isMouseDown) {
            gameState.isMouseDown = false;
            checkSelection();
        }
    });
    
    // è§¸æ§äº‹ä»¶ç›£è½ (ç‚ºå¹³æ¿èˆ‡æ‰‹æ©Ÿå„ªåŒ–)
    gridContainer.addEventListener('touchstart', e => {
        if (e.target.classList.contains('grid-cell')) {
            e.preventDefault(); // é˜²æ­¢æ»‘å‹•æ™‚é é¢æ»¾å‹•
            gameState.isMouseDown = true;
            gameState.selection = [e.target];
            e.target.classList.add('selecting');
        }
    }, { passive: false });

    gridContainer.addEventListener('touchmove', e => {
        if (gameState.isMouseDown) {
            e.preventDefault();
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (element && element.classList.contains('grid-cell') && !gameState.selection.includes(element)) {
                const lastCell = gameState.selection[gameState.selection.length - 1];
                const currentRow = parseInt(element.dataset.row);
                const currentCol = parseInt(element.dataset.col);
                const lastRow = parseInt(lastCell.dataset.row);
                const lastCol = parseInt(lastCell.dataset.col);

                if (currentRow === lastRow || currentCol === lastCol) { // åƒ…é™ç›´ç·š
                    gameState.selection.push(element);
                    element.classList.add('selecting');
                }
            }
        }
    }, { passive: false });

    window.addEventListener('touchend', () => {
        if (gameState.isMouseDown) {
            gameState.isMouseDown = false;
            checkSelection();
        }
    });

    // æç¤ºæŒ‰éˆ•
    hintBtn.addEventListener('click', () => {
        if (gameState.hintsLeft > 0) {
            const unfoundWord = gameState.words.find(w => !gameState.foundWords.includes(w.word));
            if (unfoundWord) {
                gameState.hintsLeft--;
                gameState.score -= 25;
                scoreEl.textContent = gameState.score;
                hintsLeftEl.textContent = gameState.hintsLeft;
                
                const { row, col } = unfoundWord.placed;
                const firstLetterCell = document.querySelector(`.grid-cell[data-row='${row}'][data-col='${col}']`);
                firstLetterCell.classList.add('hint');
                setTimeout(() => firstLetterCell.classList.remove('hint'), 3000);
            }
        }
        if (gameState.hintsLeft === 0) {
            hintBtn.disabled = true;
            hintBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    });

    // è‡ªè¨‚éŠæˆ²åˆ†é åˆ‡æ›
    tabStandard.addEventListener('click', () => {
        standardSettings.classList.remove('hidden');
        customSettings.classList.add('hidden');
        tabStandard.classList.add('text-blue-600', 'border-blue-600');
        tabStandard.classList.remove('text-slate-500');
        tabCustom.classList.remove('text-blue-600', 'border-blue-600');
        tabCustom.classList.add('text-slate-500');
    });

    tabCustom.addEventListener('click', () => {
        customSettings.classList.remove('hidden');
        standardSettings.classList.add('hidden');
        tabCustom.classList.add('text-blue-600', 'border-blue-600');
        tabCustom.classList.remove('text-slate-500');
        tabStandard.classList.remove('text-blue-600', 'border-blue-600');
        tabStandard.classList.add('text-slate-500');
    });
    
    // ç”¢ç”Ÿåˆ†äº«é€£çµ
    generateLinkBtn.addEventListener('click', () => {
        const theme = customThemeInput.value.trim() || 'è‡ªè¨‚éŠæˆ²';
        const words = customWordsInput.value.split(',')
            .map(w => w.trim().toUpperCase())
            .filter(w => w.length > 1 && w.length <= 12); // éæ¿¾ä¸åˆé©çš„å–®å­—

        if (words.length < 3) {
            alert('è«‹è‡³å°‘è¼¸å…¥3å€‹æœ‰æ•ˆçš„å–®å­—ï¼');
            return;
        }

        const customGameData = {
            theme: { name: theme },
            words: words.map(w => ({ word: w, def: 'è‡ªè¨‚å–®å­—', emoji: 'ğŸŒŸ' }))
        };

        const encodedData = btoa(JSON.stringify(customGameData));
        const url = `${window.location.origin}${window.location.pathname}#${encodedData}`;
        
        generatedLinkInput.value = url;
        linkContainer.classList.remove('hidden');
    });

    copyLinkBtn.addEventListener('click', () => {
        generatedLinkInput.select();
        document.execCommand('copy');
        copyLinkBtn.textContent = 'å·²è¤‡è£½!';
        setTimeout(() => { copyLinkBtn.textContent = 'è¤‡è£½é€£çµ'; }, 2000);
    });

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰è‡ªè¨‚éŠæˆ²è³‡æ–™
    function checkUrlForCustomGame() {
        if (window.location.hash) {
            try {
                const encodedData = window.location.hash.substring(1);
                const decodedData = JSON.parse(atob(encodedData));
                
                if (decodedData.words && decodedData.words.length > 0) {
                    // å°‡è‡ªè¨‚è³‡æ–™æš«å­˜
                    wordData.custom = decodedData;
                    
                    // æ ¹æ“šå–®å­—æ•¸é‡è‡ªå‹•æ±ºå®šé›£åº¦
                    const wordCount = decodedData.words.length;
                    let difficultyKey = 'easy';
                    if (wordCount > 12) difficultyKey = 'hard';
                    else if (wordCount > 8) difficultyKey = 'normal';

                    const settings = {
                        theme: 'custom',
                        ...difficultySettings[difficultyKey],
                        isTimerOn: true, // è‡ªè¨‚éŠæˆ²é è¨­é–‹å•Ÿè¨ˆæ™‚
                    };
                    
                    // å¼·åˆ¶è¦†å¯«å–®å­—æ•¸é‡
                    settings.wordCount = wordCount;

                    // æ¸…é™¤ hash é¿å…é‡æ–°æ•´ç†æ™‚å†æ¬¡è¼‰å…¥
                    history.pushState("", document.title, window.location.pathname + window.location.search);
                    initGame(settings);
                }
            } catch (error) {
                console.error("ç„¡æ³•è§£æè‡ªè¨‚éŠæˆ²é€£çµ:", error);
                // è§£æå¤±æ•—ï¼Œæ­£å¸¸é¡¯ç¤ºé–‹å§‹ç•«é¢
            }
        }
    }
    
    // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
    window.onload = checkUrlForCustomGame;

    </script>
</body>
</html>

